---
title: springboot部署
date: 2025-02-19 11:03:21
toc: true
cover: /img/thumbnail/学习/后端/springboot/springboot.png
thumbnail: /img/thumbnail/学习/后端/springboot/springboot.png
categories: 
- 学习
- 后端
tags: 
- 后端
- springboot
- docker
- jenkins
---

# Jenkins

可使用**Docker**部署**Jenkins**，并将创建挂载点将安装的**Docker**（因为需要在Jenkins容器内使用docker，docker-compose），**Maven**，**Java JDK**等（相关的一些依赖也可以统一管理）也一起挂载。可采用**Docker Compose**进行安装Jenkins，如下：

<!--more-->

## 创建docker-compose.yml

```yml
version: "3.1"
services:
  jenkins:
        image: jenkins/jenkins:lts
        user: root
        container_name: jenkins
        ports:
          - 8080:8080
          - 50000:50000
        privileged: true
        volumes:
          - ./data/:/var/jenkins_home/
          - /usr/bin/docker:/usr/bin/docker
          - /var/run/docker.sock:/var/run/docker.sock
          - /usr/local/bin/docker-compose:/usr/local/bin/docker-compose
          - /usr/bin/docker-compose:/usr/bin/docker-compose
          - /usr/lib/dockerlib:/usr/lib/dockerlib
```


## 上传文件到服务器

可自由选择目录上传，我是上传到**\/usr/local/jenkins-docker**中

## 运行

在运行之前，可以先拉取**jenkins**镜像，运行命令**docker pull jenkins/jenkins:latest**拉取最新的镜像，之后在**docker-compose.yml**所在目录下运行**docker-compose up -d**命令，**-d**指在后台运行。

## 配置Jenkins

**Jenkins**需要配置下**maven**和**Java JDK**（可选），在系统管理—全局根据配置—**Maven**配置中配置上传的**maven**的**settings.xml**路径，并在**Maven**安装中新增**Maven**，路径为**Maven**安装路径。具体看**Maven**部分。

## 创建任务

1. 新建一个任务（自由风格）。
2. 填写**Github**地址和分支。
3. 新增**Build Steps**。

选择**Maven**，并在目标中填写**clean install -Dmaven.test.skip=true**

选择**shell**，并写入

```shell
cd /var/jenkins_home/workspace/springboot-demo
docker-compose up -d --build
```

4. 保存后进行构建。

# Maven

**Maven**可以安装和管理**Springboot**依赖，由于我们是通过**Docker**部署的**Jenkins**，需要在本地先安装，并修改**settings.xml**，修改源，加快安装依赖的速度，然后将其挂载到**Jenkins**容器中。

## 下载安装

1. 在官网中下载

[Maven下载地址](https://maven.apache.org/download.cgi)

2. 上传到服务器

我将其放在**\/usr/lib/dockerlib/maven**路径中，然后解压

3. 添加源

在**config**文件夹里的**settings.xml**中添加：

```xml
<mirror>
  <id>alimaven</id>
  <name>aliyun maven</name>
  <url>http://maven.aliyun.com/nexus/content/groups/public/</url>
  <mirrorOf>central</mirrorOf>
</mirror>
```

3. 挂载**Maven**

启动Jenkins容器时，将其挂载在Jenkins的容器目录中。

```yml
 volumes:
   - /usr/lib/dockerlib:/usr/lib/dockerlib
```

4. 在**Jenkins**中配置

{% asset_img maven1.png %}

{% asset_img maven2.png %}

## SpringBoot

**Springboot**需对**MySql**和**Redis**进行配置，然后新建**Dockerfile**和**docker-compose.yml**文件，用于启动docker容器。

```yml
version: '3.8'

services:
  # MySQL 服务
  mysql:
    image: mysql:5.7
    container_name: mysql-container
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: user_db
    ports:
      - "3306:3306"
    networks:
      - my-network
    volumes:
      - /usr/local/mysql-docker:/var/lib/mysql

  # Redis 服务
  redis:
    image: redis:latest
    container_name: redis-container
    ports:
      - "6379:6379"
    networks:
      - my-network

  # Spring Boot 应用服务
  springboot-app:
    build:
      context: .
      dockerfile: Dockerfile # 指定Dockerfile路径，默认是当前目录下的 Dockerfile
    container_name: springboot-app
    ports:
      - "8081:8081"
    depends_on:
      - mysql
      - redis
    networks:
      - my-network

networks:
  my-network:
    driver: bridge
```

```dockerfile
# 使用官方的 OpenJDK 镜像
FROM openjdk:17-jdk-slim

# 设置工作目录
WORKDIR /app

# 将 JAR 文件复制到容器中
COPY target/demo-0.0.1-SNAPSHOT.jar /app/demo-0.0.1-SNAPSHOT.jar

# 暴露端口
EXPOSE 8081

# 启动应用
ENTRYPOINT ["java", "-jar", "/app/demo-0.0.1-SNAPSHOT.jar"]
```

# 其他注意

## SSH key

如果要在**Jenkins**配置**git ssh**公钥，需要在Jenkins容器中切换用户为**Jenkins**，**su jenkins**，然后再执行接下来命令：

```shell
1. 检查密钥
ls -al ~/.ssh
2. 生成密钥
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
3. 将 SSH 密钥添加到 SSH 代理
eval "$(ssh-agent -s)"
ssh-add ~/.ssh/id_rsa
4. 查看密钥，并将密钥配置到github
cat ~/.ssh/id_rsa.pub
5. 测试 SSH 连接
ssh -T git@github.com
```

或者直接拷贝服务器中的**id_rsa**和**id_rsa.pub**文件到**Jenkins**容器中，再进行从第三步开始。

```shell
docker cp ~/.ssh/id_rsa jenkins:~/.ssh/id_rsa
docker cp ~/.ssh/id_rsa.pub jenkins:~/.ssh/id_rsa.pub
```

## 修改 Jenkins 容器内的时区（适用于已运行的容器）

如果 Jenkins 容器已经在运行，可以通过以下步骤修改时区：

1. **进入容器**：

   ```shell
   docker exec -it jenkins bash
   ```

2. **修改时区**：

   ```shell
   echo "Asia/Shanghai" > /etc/timezone
   ln -fs /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
   ```

3. **退出并重启容器**：

   ```shell
   docker restart jenkins
   ```